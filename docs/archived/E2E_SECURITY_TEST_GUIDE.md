# ğŸ”’ ç«¯åˆ°ç«¯å®‰å…¨æµ‹è¯•æŒ‡å—

## æ¦‚è¿°

æœ¬æµ‹è¯•å°†åœ¨çœŸå®çš„ AWS Lightsail ç¯å¢ƒä¸­æ‰§è¡Œå®Œæ•´çš„å®‰å…¨é…ç½®æµç¨‹ï¼ŒéªŒè¯æ‰€æœ‰å®‰å…¨åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

---

## âš ï¸ é‡è¦æç¤º

### è´¹ç”¨è¯´æ˜
- **é¢„è®¡è´¹ç”¨**: çº¦ $0.01-0.02 USD
- **å®ä¾‹ç±»å‹**: nano_2_0 (512MB RAM, 1 vCPU)
- **æµ‹è¯•æ—¶é—´**: çº¦ 10-15 åˆ†é’Ÿ
- **è‡ªåŠ¨æ¸…ç†**: æµ‹è¯•å®Œæˆåè‡ªåŠ¨åˆ é™¤å®ä¾‹

### å‰ææ¡ä»¶
1. âœ… AWS å‡­è¯å·²é…ç½®
2. âœ… æœ‰ Lightsail åˆ›å»ºå’Œåˆ é™¤æƒé™
3. âœ… Conda ç¯å¢ƒ `quants-infra` å·²åˆ›å»º
4. âœ… æ‰€æœ‰ä¾èµ–å·²å®‰è£…

---

## ğŸ“‹ æµ‹è¯•å†…å®¹

### æµ‹è¯• 1: å®ä¾‹åˆ›å»ºéªŒè¯
- åˆ›å»º Lightsail æµ‹è¯•å®ä¾‹
- éªŒè¯å®ä¾‹çŠ¶æ€å’Œ IP
- æµ‹è¯• SSH è¿æ¥

### æµ‹è¯• 2: åˆå§‹å®‰å…¨é…ç½®
- ç³»ç»Ÿæ›´æ–°
- å®‰è£…åŸºç¡€å·¥å…· (iptables, net-tools, python3-pip)
- åˆ›å»ºå®‰å…¨ç›®å½•ç»“æ„

### æµ‹è¯• 3: é˜²ç«å¢™é…ç½® (default profile)
- é…ç½® iptables è§„åˆ™
- è®¾ç½®é»˜è®¤ DROP ç­–ç•¥
- éªŒè¯åŸºæœ¬è§„åˆ™ï¼ˆESTABLISHED, RELATED, Loopbackï¼‰

### æµ‹è¯• 4: SSH å®‰å…¨åŠ å›º
- ä¿®æ”¹ SSH ç«¯å£ (22 â†’ 6677)
- ç¦ç”¨å¯†ç è®¤è¯
- ç¦ç”¨ Root ç™»å½•
- å¯ç”¨å¯†é’¥è®¤è¯
- éªŒè¯æ–°ç«¯å£è¿æ¥

### æµ‹è¯• 5: fail2ban å®‰è£…
- å®‰è£… fail2ban
- é…ç½® sshd jail
- éªŒè¯æœåŠ¡è¿è¡ŒçŠ¶æ€

### æµ‹è¯• 6: å®‰å…¨é…ç½®éªŒè¯
- è¿è¡Œå®Œæ•´å®‰å…¨éªŒè¯
- æ£€æŸ¥æ‰€æœ‰å®‰å…¨æ ‡è®°
- éªŒè¯é…ç½®æ–‡ä»¶

### æµ‹è¯• 7: é˜²ç«å¢™è§„åˆ™æŒä¹…åŒ–
- æ£€æŸ¥ iptables-persistent é…ç½®
- éªŒè¯è§„åˆ™æ–‡ä»¶å­˜åœ¨
- ç¡®è®¤è§„åˆ™å·²ä¿å­˜

### æµ‹è¯• 8: å¼€æ”¾ç«¯å£æ£€æŸ¥
- æ£€æŸ¥ç›‘å¬ç«¯å£
- éªŒè¯ SSH ç«¯å£ (6677)
- ç¡®è®¤æ— ä¸å¿…è¦ç«¯å£å¼€æ”¾

### æµ‹è¯• 9: å®‰å…¨é…ç½®æ ‡è®°
- æ£€æŸ¥æ‰€æœ‰å®‰å…¨æ ‡è®°æ–‡ä»¶
- éªŒè¯é…ç½®å®ŒæˆçŠ¶æ€

### æµ‹è¯• 10: ç³»ç»Ÿæ—¥å¿—æ£€æŸ¥
- æ£€æŸ¥è®¤è¯æ—¥å¿— (/var/log/auth.log)
- æ£€æŸ¥ fail2ban æ—¥å¿—

### æµ‹è¯• 11: æ•°æ®é‡‡é›†å™¨é…ç½® (é«˜çº§)
- è°ƒæ•´é˜²ç«å¢™ä¸ºæ•°æ®é‡‡é›†å™¨é…ç½®
- éªŒè¯ VPN é™åˆ¶ç«¯å£

### æµ‹è¯• 12: CLI å‘½ä»¤æµ‹è¯• (é«˜çº§)
- æµ‹è¯• quants-ctl security å‘½ä»¤

### æµ‹è¯• 13: å¤‡ä»½æ–‡ä»¶éªŒè¯ (é«˜çº§)
- æ£€æŸ¥å¤‡ä»½ç›®å½•
- éªŒè¯å¤‡ä»½æ–‡ä»¶

---

## ğŸš€ æ‰§è¡Œæµ‹è¯•

### æ–¹æ³• 1: ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ (æ¨è)

```bash
cd /Users/alice/Dropbox/æŠ•èµ„/é‡åŒ–äº¤æ˜“/infrastructure

# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x run_e2e_security_tests.sh

# è¿è¡Œæµ‹è¯•
./run_e2e_security_tests.sh
```

è„šæœ¬ä¼šï¼š
1. âœ… æ£€æŸ¥ AWS å‡­è¯
2. âœ… æ¿€æ´» Conda ç¯å¢ƒ
3. âœ… ç¡®è®¤æµ‹è¯•æ‰§è¡Œ
4. âœ… è¿è¡Œæ‰€æœ‰æµ‹è¯•
5. âœ… ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
6. âœ… è‡ªåŠ¨æ¸…ç†èµ„æº

### æ–¹æ³• 2: æ‰‹åŠ¨æ‰§è¡Œ

```bash
cd /Users/alice/Dropbox/æŠ•èµ„/é‡åŒ–äº¤æ˜“/infrastructure

# æ¿€æ´»ç¯å¢ƒ
conda activate quants-infra

# è¿è¡Œæµ‹è¯•
pytest tests/e2e/test_security_e2e.py -v -s
```

---

## ğŸ“Š æµ‹è¯•è¾“å‡º

### æˆåŠŸè¾“å‡ºç¤ºä¾‹

```
=========================================
æµ‹è¯• 1: éªŒè¯å®ä¾‹å·²åˆ›å»º
=========================================
âœ“ å®ä¾‹åç§°: security-test-1234567890
âœ“ å®ä¾‹ IP: 52.xxx.xxx.xxx
âœ“ SSH å¯†é’¥: /Users/alice/.ssh/lightsail-test-key.pem

=========================================
æµ‹è¯• 2: åˆå§‹å®‰å…¨é…ç½®
=========================================
æ‰§è¡Œåˆå§‹å®‰å…¨é…ç½®...
âœ“ åˆå§‹å®‰å…¨é…ç½®æˆåŠŸ

éªŒè¯å®‰è£…çš„å·¥å…·...
  âœ“ iptables å·²å®‰è£…
  âœ“ iptables-persistent å·²å®‰è£…
  âœ“ net-tools å·²å®‰è£…
  âœ“ python3-pip å·²å®‰è£…

=========================================
æµ‹è¯• 3: é˜²ç«å¢™é…ç½® (default)
=========================================
é…ç½®é˜²ç«å¢™ (default profile)...
âœ“ é˜²ç«å¢™é…ç½®æˆåŠŸ

éªŒè¯é˜²ç«å¢™è§„åˆ™...
  âœ“ é»˜è®¤ç­–ç•¥æ­£ç¡® (INPUT: DROP, FORWARD: DROP, OUTPUT: ACCEPT)
  âœ“ ESTABLISHED,RELATED è¿æ¥å…è®¸
  âœ“ Loopback æ¥å£å…è®¸

...
```

### æµ‹è¯•æŠ¥å‘Šä½ç½®

æµ‹è¯•æŠ¥å‘Šè‡ªåŠ¨ä¿å­˜åˆ°ï¼š
```
infrastructure/test_reports/e2e_security_test_YYYYMMDD_HHMMSS.log
```

---

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ 1: AWS å‡­è¯æœªé…ç½®

**é”™è¯¯ä¿¡æ¯**:
```
âœ— AWS å‡­è¯æœªé…ç½®
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
export AWS_ACCESS_KEY_ID=your_access_key
export AWS_SECRET_ACCESS_KEY=your_secret_key
export AWS_DEFAULT_REGION=ap-northeast-1
```

### é—®é¢˜ 2: Lightsail å¯†é’¥å¯¹ä¸å­˜åœ¨

**é”™è¯¯ä¿¡æ¯**:
```
KeyPairNotFoundException
```

**è§£å†³æ–¹æ¡ˆ**:
æµ‹è¯•ä¼šè‡ªåŠ¨åˆ›å»ºå¯†é’¥å¯¹ `lightsail-test-key`ã€‚å¦‚æœå¤±è´¥ï¼Œæ‰‹åŠ¨åˆ›å»ºï¼š

```bash
aws lightsail create-key-pair \
  --key-pair-name lightsail-test-key \
  --query 'privateKeyBase64' \
  --output text > ~/.ssh/lightsail-test-key.pem

chmod 600 ~/.ssh/lightsail-test-key.pem
```

### é—®é¢˜ 3: å®ä¾‹å¯åŠ¨è¶…æ—¶

**åŸå› **: AWS Lightsail æœ‰æ—¶å“åº”è¾ƒæ…¢

**è§£å†³æ–¹æ¡ˆ**:
- ç­‰å¾…æ›´é•¿æ—¶é—´ï¼ˆæµ‹è¯•é»˜è®¤ç­‰å¾… 3 åˆ†é’Ÿï¼‰
- æ£€æŸ¥ AWS Lightsail æ§åˆ¶å°çŠ¶æ€
- é‡æ–°è¿è¡Œæµ‹è¯•

### é—®é¢˜ 4: SSH è¿æ¥å¤±è´¥

**å¯èƒ½åŸå› **:
1. å®ä¾‹å°šæœªå®Œå…¨åˆå§‹åŒ–
2. å®‰å…¨ç»„é…ç½®é—®é¢˜
3. SSH å¯†é’¥æƒé™é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥å¯†é’¥æƒé™
ls -la ~/.ssh/lightsail-test-key.pem
# åº”è¯¥æ˜¾ç¤º -rw------- (600)

# å¦‚æœæƒé™ä¸å¯¹
chmod 600 ~/.ssh/lightsail-test-key.pem

# æ‰‹åŠ¨æµ‹è¯• SSH è¿æ¥
ssh -i ~/.ssh/lightsail-test-key.pem ubuntu@<instance-ip>
```

### é—®é¢˜ 5: æµ‹è¯•ä¸­æ–­åèµ„æºæœªæ¸…ç†

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥æ‰¾æµ‹è¯•å®ä¾‹
aws lightsail get-instances --query 'instances[?starts_with(name, `security-test-`)].name' --output text

# æ‰‹åŠ¨åˆ é™¤
aws lightsail delete-instance --instance-name security-test-XXXXXXXXXX
```

---

## ğŸ“ˆ æµ‹è¯•æŒ‡æ ‡

### é¢„æœŸæµ‹è¯•æ—¶é—´

| é˜¶æ®µ | é¢„è®¡æ—¶é—´ | è¯´æ˜ |
|------|---------|------|
| å®ä¾‹åˆ›å»º | 2-3 åˆ†é’Ÿ | Lightsail å®ä¾‹å¯åŠ¨ |
| SSH å°±ç»ª | 1-2 åˆ†é’Ÿ | ç³»ç»Ÿåˆå§‹åŒ– |
| å®‰å…¨é…ç½® | 3-5 åˆ†é’Ÿ | æ‰€æœ‰å®‰å…¨ playbook |
| éªŒè¯æµ‹è¯• | 2-3 åˆ†é’Ÿ | æ‰€æœ‰éªŒè¯æ­¥éª¤ |
| èµ„æºæ¸…ç† | 1 åˆ†é’Ÿ | åˆ é™¤å®ä¾‹ |
| **æ€»è®¡** | **10-15 åˆ†é’Ÿ** | - |

### æˆåŠŸç‡ç›®æ ‡

- âœ… æµ‹è¯•é€šè¿‡ç‡: 100% (13/13)
- âœ… é…ç½®æˆåŠŸç‡: 100%
- âœ… éªŒè¯é€šè¿‡ç‡: 100%

---

## ğŸ” æ·±åº¦éªŒè¯

### æ‰‹åŠ¨éªŒè¯æ¸…å•

å¦‚æœéœ€è¦æ›´æ·±å…¥çš„éªŒè¯ï¼Œå¯ä»¥åœ¨æµ‹è¯•å®Œæˆä½†å®ä¾‹æœªåˆ é™¤å‰ï¼Œæ‰‹åŠ¨æ£€æŸ¥ï¼š

```bash
# SSH è¿æ¥åˆ°æµ‹è¯•å®ä¾‹
ssh -p 6677 -i ~/.ssh/lightsail-test-key.pem ubuntu@<instance-ip>

# 1. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
sudo iptables -L -v -n

# 2. æ£€æŸ¥ SSH é…ç½®
cat /etc/ssh/sshd_config | grep -E "Port|PasswordAuthentication|PermitRootLogin|PubkeyAuthentication"

# 3. æ£€æŸ¥ fail2ban çŠ¶æ€
sudo fail2ban-client status
sudo fail2ban-client status sshd

# 4. æ£€æŸ¥å®‰å…¨æ ‡è®°
ls -la /etc/quants-security/

# 5. æ£€æŸ¥ç›‘å¬ç«¯å£
sudo netstat -tulnp

# 6. æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—
sudo tail -50 /var/log/auth.log
sudo tail -50 /var/log/fail2ban.log

# 7. æ£€æŸ¥å¤‡ä»½æ–‡ä»¶
ls -la /etc/quants-security/backups/
```

---

## ğŸ“ æµ‹è¯•è®°å½•æ¨¡æ¿

```markdown
# ç«¯åˆ°ç«¯å®‰å…¨æµ‹è¯•è®°å½•

**æµ‹è¯•æ—¥æœŸ**: YYYY-MM-DD HH:MM:SS
**æµ‹è¯•äººå‘˜**: [Your Name]
**ç¯å¢ƒ**: AWS Lightsail ap-northeast-1

## æµ‹è¯•ç»“æœ

- [ ] æµ‹è¯• 1: å®ä¾‹åˆ›å»ºéªŒè¯
- [ ] æµ‹è¯• 2: åˆå§‹å®‰å…¨é…ç½®
- [ ] æµ‹è¯• 3: é˜²ç«å¢™é…ç½®
- [ ] æµ‹è¯• 4: SSH å®‰å…¨åŠ å›º
- [ ] æµ‹è¯• 5: fail2ban å®‰è£…
- [ ] æµ‹è¯• 6: å®‰å…¨é…ç½®éªŒè¯
- [ ] æµ‹è¯• 7: é˜²ç«å¢™è§„åˆ™æŒä¹…åŒ–
- [ ] æµ‹è¯• 8: å¼€æ”¾ç«¯å£æ£€æŸ¥
- [ ] æµ‹è¯• 9: å®‰å…¨é…ç½®æ ‡è®°
- [ ] æµ‹è¯• 10: ç³»ç»Ÿæ—¥å¿—æ£€æŸ¥
- [ ] æµ‹è¯• 11: æ•°æ®é‡‡é›†å™¨é…ç½®
- [ ] æµ‹è¯• 12: CLI å‘½ä»¤æµ‹è¯•
- [ ] æµ‹è¯• 13: å¤‡ä»½æ–‡ä»¶éªŒè¯

## é—®é¢˜è®°å½•

| æµ‹è¯•é¡¹ | é—®é¢˜æè¿° | è§£å†³æ–¹æ¡ˆ | çŠ¶æ€ |
|--------|---------|---------|------|
|        |         |         |      |

## æ€»ç»“

**é€šè¿‡ç‡**: __/13 (___%)
**æ€»æ—¶é—´**: ___ åˆ†é’Ÿ
**å»ºè®®**: 

```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

### æµ‹è¯•é€šè¿‡å

1. âœ… æŸ¥çœ‹è¯¦ç»†æµ‹è¯•æŠ¥å‘Š
2. âœ… å½’æ¡£æµ‹è¯•æ—¥å¿—
3. âœ… æ›´æ–°é¡¹ç›®æ–‡æ¡£
4. âœ… æ ‡è®°ç”Ÿäº§å°±ç»ª

### æµ‹è¯•å¤±è´¥æ—¶

1. ğŸ“‹ è®°å½•å¤±è´¥è¯¦æƒ…
2. ğŸ› åˆ†æå¤±è´¥åŸå› 
3. ğŸ”§ ä¿®å¤é—®é¢˜
4. ğŸ”„ é‡æ–°è¿è¡Œæµ‹è¯•

---

## ğŸ“ æ”¯æŒ

**é¡¹ç›®ç»´æŠ¤è€…**: Infrastructure Team  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2024-11-21

---

## ğŸ‰ æˆåŠŸæ ‡å‡†

æµ‹è¯•æˆåŠŸçš„æ ‡å‡†ï¼š

âœ… æ‰€æœ‰ 13 ä¸ªæµ‹è¯•é€šè¿‡  
âœ… æ— é”™è¯¯æ—¥å¿—  
âœ… æ‰€æœ‰å®‰å…¨æ ‡è®°æ–‡ä»¶å­˜åœ¨  
âœ… é˜²ç«å¢™è§„åˆ™æ­£ç¡®é…ç½®  
âœ… SSH åŠ å›ºç”Ÿæ•ˆ  
âœ… fail2ban æ­£å¸¸è¿è¡Œ  
âœ… æµ‹è¯•å®ä¾‹è‡ªåŠ¨æ¸…ç†  

**ç¥æµ‹è¯•é¡ºåˆ©ï¼** ğŸš€

