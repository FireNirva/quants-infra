# Alertmanager é…ç½®æ–‡ä»¶
# ç”± Ansible è‡ªåŠ¨ç”Ÿæˆï¼ŒåŸºäº quants-lab/config/alertmanager.yml

global:
  resolve_timeout: {{ resolve_timeout | default('5m') }}
  
{% if smtp_config is defined %}
  # SMTP é…ç½®ï¼ˆé‚®ä»¶é€šçŸ¥ï¼‰
  smtp_smarthost: '{{ smtp_config.smarthost | default("smtp.gmail.com:587") }}'
  smtp_from: '{{ smtp_config.from }}'
  smtp_auth_username: '{{ smtp_config.username }}'
  smtp_auth_password: '{{ smtp_config.password }}'
  smtp_require_tls: {{ smtp_config.require_tls | default(true) | lower }}
{% endif %}

# å‘Šè­¦è·¯ç”±é…ç½®
route:
  # é»˜è®¤æ¥æ”¶å™¨
  receiver: '{{ default_receiver | default("default-receiver") }}'
  
  # åˆ†ç»„é…ç½®
  group_by: ['alertname', 'exchange', 'symbol']
  group_wait: {{ group_wait | default('30s') }}
  group_interval: {{ group_interval | default('5m') }}
  repeat_interval: {{ repeat_interval | default('4h') }}
  
  # å­è·¯ç”± - æ ¹æ®ä¸¥é‡ç¨‹åº¦è·¯ç”±
  routes:
    # ä¸¥é‡å‘Šè­¦ - ç«‹å³é€šçŸ¥
    - receiver: 'critical-alerts'
      match:
        severity: critical
      group_wait: 10s
      group_interval: 2m
      repeat_interval: 1h
      continue: false
    
    # è­¦å‘Šå‘Šè­¦ - å»¶è¿Ÿé€šçŸ¥
    - receiver: 'warning-alerts'
      match:
        severity: warning
      group_wait: 1m
      group_interval: 10m
      repeat_interval: 12h
      continue: false
    
    # è¿æ¥æ€§å‘Šè­¦
    - receiver: 'connectivity-alerts'
      match:
        category: connectivity
      group_wait: 15s
      repeat_interval: 2h
      continue: true

# æ¥æ”¶å™¨é…ç½®
receivers:
  # é»˜è®¤æ¥æ”¶å™¨
  - name: 'default-receiver'
{% if webhook_url is defined %}
    webhook_configs:
      - url: '{{ webhook_url }}'
        send_resolved: true
{% endif %}

  # ä¸¥é‡å‘Šè­¦æ¥æ”¶å™¨
  - name: 'critical-alerts'
{% if email_to is defined %}
    email_configs:
      - to: '{{ email_to }}'
        headers:
          Subject: 'ğŸš¨ [CRITICAL] {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'
        html: |
          <h2>ä¸¥é‡å‘Šè­¦</h2>
          <p><strong>å‘Šè­¦åç§°:</strong> {% raw %}{{ .GroupLabels.alertname }}{% endraw %}</p>
          <p><strong>äº¤æ˜“æ‰€:</strong> {% raw %}{{ .GroupLabels.exchange }}{% endraw %}</p>
          <p><strong>äº¤æ˜“å¯¹:</strong> {% raw %}{{ .GroupLabels.symbol }}{% endraw %}</p>
          <p><strong>æè¿°:</strong> {% raw %}{{ .CommonAnnotations.description }}{% endraw %}</p>
          <p><strong>æ—¶é—´:</strong> {% raw %}{{ .StartsAt }}{% endraw %}</p>
        send_resolved: true
{% endif %}
    
{% set telegram_token = telegram_bot_token | default('') | trim %}
{% set telegram_chat = telegram_chat_id | default('') | trim %}
{% if telegram_token and telegram_chat %}
    # Telegram é€šçŸ¥
    telegram_configs:
      - bot_token: '{{ telegram_token }}'
        chat_id: {{ telegram_chat }}
        message: |
          ğŸš¨ *CRITICAL ALERT*
          
          *Alert:* {% raw %}{{ .GroupLabels.alertname }}{% endraw %}
          *Exchange:* {% raw %}{{ .GroupLabels.exchange }}{% endraw %}
          *Symbol:* {% raw %}{{ .GroupLabels.symbol }}{% endraw %}
          *Description:* {% raw %}{{ .CommonAnnotations.description }}{% endraw %}
          *Started:* {% raw %}{{ .StartsAt }}{% endraw %}
        parse_mode: 'Markdown'
        send_resolved: true
{% endif %}
    
{% if slack_webhook_url is defined %}
    # Slack é€šçŸ¥
    slack_configs:
      - api_url: '{{ slack_webhook_url }}'
        channel: '{{ slack_channel | default("#critical-alerts") }}'
        title: 'ğŸš¨ Critical Alert: {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'
        text: |
          *Exchange:* {% raw %}{{ .GroupLabels.exchange }}{% endraw %}
          *Symbol:* {% raw %}{{ .GroupLabels.symbol }}{% endraw %}
          *Description:* {% raw %}{{ .CommonAnnotations.description }}{% endraw %}
        send_resolved: true
{% endif %}

  # è­¦å‘Šå‘Šè­¦æ¥æ”¶å™¨
  - name: 'warning-alerts'
{% if email_to is defined %}
    email_configs:
      - to: '{{ email_to }}'
        headers:
          Subject: 'âš ï¸ [WARNING] {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'
        html: |
          <h2>è­¦å‘Šå‘Šè­¦</h2>
          <p><strong>å‘Šè­¦åç§°:</strong> {% raw %}{{ .GroupLabels.alertname }}{% endraw %}</p>
          <p><strong>äº¤æ˜“æ‰€:</strong> {% raw %}{{ .GroupLabels.exchange }}{% endraw %}</p>
          <p><strong>äº¤æ˜“å¯¹:</strong> {% raw %}{{ .GroupLabels.symbol }}{% endraw %}</p>
          <p><strong>æè¿°:</strong> {% raw %}{{ .CommonAnnotations.description }}{% endraw %}</p>
        send_resolved: true
{% endif %}

  # è¿æ¥æ€§å‘Šè­¦æ¥æ”¶å™¨
  - name: 'connectivity-alerts'
{% if webhook_url is defined %}
    webhook_configs:
      - url: '{{ webhook_url }}/connectivity'
        send_resolved: true
{% endif %}

# å‘Šè­¦æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # å¦‚æœæœ‰ä¸¥é‡å‘Šè­¦ï¼ŒæŠ‘åˆ¶ç›¸åŒæ¥æºçš„è­¦å‘Šå‘Šè­¦
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['exchange', 'symbol']
  
  # å¦‚æœWebSocketæ–­å¼€ï¼ŒæŠ‘åˆ¶æ•°æ®è¿‡æœŸå‘Šè­¦ï¼ˆå› ä¸ºæ ¹æœ¬åŸå› æ˜¯æ–­å¼€ï¼‰
  - source_match:
      alertname: 'WebSocketDisconnected'
    target_match:
      alertname: 'DataStale'
    equal: ['exchange', 'symbol']
  
  # å¦‚æœæ•°æ®ä¸¥é‡è¿‡æœŸï¼ŒæŠ‘åˆ¶æ™®é€šè¿‡æœŸå‘Šè­¦
  - source_match:
      alertname: 'DataVeryStale'
    target_match:
      alertname: 'DataStale'
    equal: ['exchange', 'symbol']
