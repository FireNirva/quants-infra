---
- name: 安装和配置 Freqtrade
  hosts: all
  become: true
  become_method: sudo
  gather_facts: true

  vars:
    ft_dir: "/opt/freqtrade"
    user_data_dir: "{{ ft_dir }}/user_data"
    scripts_dir: "{{ playbook_dir }}/../server/scripts/{{ ansible_host }}"

  tasks:
    - name: 安装 Python 依赖
      apt:
        name: 
          - python3-pip
          - python3-dev
          - python3-docker
          - docker-compose
        state: present
        update_cache: yes

    - name: 确保 Freqtrade 目录存在
      file:
        path: "{{ ft_dir }}"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: 下载 docker-compose.yml
      get_url:
        url: https://raw.githubusercontent.com/freqtrade/freqtrade/stable/docker-compose.yml
        dest: "{{ ft_dir }}/docker-compose.yml.original"
        mode: '0644'
        force: no

    - name: 创建用户数据目录
      file:
        path: "{{ user_data_dir }}"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: 创建远程配置目录
      file:
        path: "/tmp/freqtrade_configs"
        state: directory
        mode: '0755'
      become: true

    - name: 复制配置文件到远程服务器
      copy:
        src: "{{ playbook_dir }}/../server/scripts/{{ ansible_host }}/{{ item }}"
        dest: "/tmp/freqtrade_configs/"
        mode: '0644'
      with_items:
        - "base_config.json"
        - "{{ hostvars[inventory_hostname].freqtrade_config }}"
        - "{{ hostvars[inventory_hostname].freqtrade_strategy }}"
      ignore_errors: true

    - name: 复制主机特定的基础配置文件
      copy:
        src: "/tmp/freqtrade_configs/base_config.json"
        dest: "{{ user_data_dir }}/base_config.json"
        mode: '0644'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        remote_src: true
      register: base_config_copy

    - name: 创建策略目录
      file:
        path: "{{ user_data_dir }}/strategies"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: 检查主机特定的策略配置文件是否存在
      stat:
        path: "/tmp/freqtrade_configs/{{ hostvars[inventory_hostname].freqtrade_config }}"
      register: strategy_config_file

    - name: 检查主机特定的策略文件是否存在
      stat:
        path: "/tmp/freqtrade_configs/{{ hostvars[inventory_hostname].freqtrade_strategy }}"
      register: strategy_file

    - name: 复制主机特定的策略配置文件
      copy:
        src: "/tmp/freqtrade_configs/{{ hostvars[inventory_hostname].freqtrade_config }}"
        dest: "{{ user_data_dir }}/{{ hostvars[inventory_hostname].freqtrade_config }}"
        mode: '0644'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        remote_src: true
        force: "{{ hostvars[inventory_hostname].force_config_update }}"
      when: strategy_config_file.stat.exists
      register: strategy_config_copy

    - name: 复制主机特定的策略文件到策略目录
      copy:
        src: "/tmp/freqtrade_configs/{{ hostvars[inventory_hostname].freqtrade_strategy }}"
        dest: "{{ user_data_dir }}/strategies/{{ hostvars[inventory_hostname].freqtrade_strategy }}"
        mode: '0644'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        remote_src: true
        force: "{{ hostvars[inventory_hostname].force_config_update }}"
      when: strategy_file.stat.exists
      register: strategy_file_copy

    - name: 使用默认策略文件（如果主机特定策略不存在）
      copy:
        content: |
          from freqtrade.strategy.interface import IStrategy
          from pandas import DataFrame
          import talib.abstract as ta
          import freqtrade.vendor.qtpylib.indicators as qtpylib

          class SampleStrategy(IStrategy):
              INTERFACE_VERSION = 3
              minimal_roi = {"0": 0.1}
              stoploss = -0.1
              timeframe = '5m'

              def populate_indicators(self, dataframe: DataFrame, metadata: dict) -> DataFrame:
                  return dataframe

              def populate_entry_trend(self, dataframe: DataFrame, metadata: dict) -> DataFrame:
                  dataframe['enter_long'] = 1
                  return dataframe

              def populate_exit_trend(self, dataframe: DataFrame, metadata: dict) -> DataFrame:
                  dataframe['exit_long'] = 0
                  return dataframe
        dest: "{{ user_data_dir }}/strategies/sample_strategy.py"
        mode: '0644'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      when: not strategy_file.stat.exists

    - name: 创建 docker-compose.yml
      template:
        src: "{{ playbook_dir }}/../templates/freqtrade/docker-compose.yml.j2"
        dest: "{{ ft_dir }}/docker-compose.yml"
        mode: '0644'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        force: "{{ hostvars[inventory_hostname].force_config_update }}"
      vars:
        base_config: "{{ hostvars[inventory_hostname].freqtrade_base_config }}"
        strategy_config: "{{ hostvars[inventory_hostname].freqtrade_config }}"
        strategy_name: "{{ hostvars[inventory_hostname].freqtrade_strategy | splitext | first }}"

    - name: 检查 Docker 是否已安装
      command: docker --version
      register: docker_check
      ignore_errors: true
      changed_when: false

    - name: 检查 Docker Compose 是否已安装
      command: docker compose version
      register: compose_check
      ignore_errors: true
      changed_when: false

    - name: 拉取 Freqtrade 镜像
      community.docker.docker_compose:
        project_src: "{{ ft_dir }}"
        pull: yes
      register: pull_result

    - name: 启动 Freqtrade 容器
      community.docker.docker_compose:
        project_src: "{{ ft_dir }}"
        state: present
      register: compose_result

    - name: 检查 Freqtrade 容器状态
      command: docker ps -f name=freqtrade
      register: container_status
      changed_when: false

    - name: 显示容器状态
      debug:
        var: container_status.stdout_lines

    - name: 显示配置信息
      debug:
        msg:
          - "使用的基础配置文件: {{ '自定义配置 (base_config.json)' if base_config_copy.changed else '默认配置' }}"
          - "使用的策略配置文件: {{ '自定义配置 (' + hostvars[inventory_hostname].freqtrade_config + ')' if strategy_config_copy.changed else '默认配置' }}"
          - "使用的策略文件: {{ '自定义策略 (' + hostvars[inventory_hostname].freqtrade_strategy + ')' if strategy_file_copy.changed else '默认策略' }}"
