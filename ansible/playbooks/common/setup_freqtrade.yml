---
- name: 安装和配置 Freqtrade
  hosts: all
  become: true
  become_method: sudo
  gather_facts: true

  vars:
    ft_dir: "/opt/freqtrade"
    user_data_dir: "{{ ft_dir }}/user_data"
    scripts_dir: "{{ playbook_dir }}/../server/scripts/{{ ansible_host }}"

  tasks:
    - name: 安装 Python 依赖
      apt:
        name: 
          - python3-pip
          - python3-dev
          - python3-docker
          - docker-compose
        state: present
        update_cache: yes

    - name: 确保 Freqtrade 目录存在
      file:
        path: "{{ ft_dir }}"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: 下载 docker-compose.yml
      get_url:
        url: https://raw.githubusercontent.com/freqtrade/freqtrade/stable/docker-compose.yml
        dest: "{{ ft_dir }}/docker-compose.yml.original"
        mode: '0644'
        force: no

    - name: 创建用户数据目录
      file:
        path: "{{ user_data_dir }}"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: 使用模板生成基础配置文件
      template:
        src: "{{ playbook_dir }}/../../templates/common/freqtrade/config.json.j2"
        dest: "{{ user_data_dir }}/base_config.json"
        mode: '0644'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      register: base_config_copy

    - name: 创建策略目录
      file:
        path: "{{ user_data_dir }}/strategies"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
    
    - name: 创建日志目录
      file:
        path: "{{ user_data_dir }}/logs"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: 检查主机特定的策略配置文件是否存在
      stat:
        path: "/tmp/freqtrade_configs/{{ freqtrade_config | default('strategy_config.json') }}"
      register: strategy_config_file
      when: freqtrade_config is defined

    - name: 检查主机特定的策略文件是否存在
      stat:
        path: "/tmp/freqtrade_configs/{{ freqtrade_strategy | default('sample_strategy.py') }}"
      register: strategy_file
      when: freqtrade_strategy is defined

    - name: 复制主机特定的策略配置文件
      copy:
        src: "/tmp/freqtrade_configs/{{ freqtrade_config }}"
        dest: "{{ user_data_dir }}/{{ freqtrade_config }}"
        mode: '0644'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        remote_src: true
        force: "{{ force_config_update | default(true) }}"
      when: freqtrade_config is defined and strategy_config_file is not skipped and strategy_config_file.stat.exists
      register: strategy_config_copy

    - name: 复制主机特定的策略文件到策略目录
      copy:
        src: "/tmp/freqtrade_configs/{{ freqtrade_strategy }}"
        dest: "{{ user_data_dir }}/strategies/{{ freqtrade_strategy }}"
        mode: '0644'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        remote_src: true
        force: "{{ force_config_update | default(true) }}"
      when: freqtrade_strategy is defined and strategy_file is not skipped and strategy_file.stat.exists
      register: strategy_file_copy

    - name: 使用默认策略文件（如果主机特定策略不存在）
      copy:
        content: |
          from freqtrade.strategy.interface import IStrategy
          from pandas import DataFrame
          import talib.abstract as ta
          import freqtrade.vendor.qtpylib.indicators as qtpylib

          class SampleStrategy(IStrategy):
              INTERFACE_VERSION = 3
              minimal_roi = {"0": 0.1}
              stoploss = -0.1
              timeframe = '5m'

              def populate_indicators(self, dataframe: DataFrame, metadata: dict) -> DataFrame:
                  return dataframe

              def populate_entry_trend(self, dataframe: DataFrame, metadata: dict) -> DataFrame:
                  dataframe['enter_long'] = 1
                  return dataframe

              def populate_exit_trend(self, dataframe: DataFrame, metadata: dict) -> DataFrame:
                  dataframe['exit_long'] = 0
                  return dataframe
        dest: "{{ user_data_dir }}/strategies/sample_strategy.py"
        mode: '0644'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      when: freqtrade_strategy is not defined or strategy_file is skipped or not strategy_file.stat.exists

    - name: 创建 docker-compose.yml
      template:
        src: "{{ playbook_dir }}/../../templates/common/freqtrade/docker-compose.yml.j2"
        dest: "{{ ft_dir }}/docker-compose.yml"
        mode: '0644'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        force: "{{ force_config_update | default(true) }}"
      vars:
        base_config: "{{ freqtrade_base_config | default('base_config.json') }}"
        strategy_config: "{{ freqtrade_config | default('') }}"
        strategy_name: "{{ strategy_name | default('SampleStrategy') }}"

    - name: 检查 Docker 是否已安装
      command: docker --version
      register: docker_check
      ignore_errors: true
      changed_when: false

    - name: 检查 Docker Compose 是否已安装
      command: docker compose version
      register: compose_check
      ignore_errors: true
      changed_when: false

    - name: 拉取 Freqtrade 镜像
      command: docker compose pull
      args:
        chdir: "{{ ft_dir }}"
      become: true
      register: pull_result
      changed_when: "'Pulling' in pull_result.stdout"

    - name: 启动 Freqtrade 容器
      command: docker compose up -d
      args:
        chdir: "{{ ft_dir }}"
      become: true
      register: compose_result
      changed_when: "'Created' in compose_result.stdout or 'Started' in compose_result.stdout"

    - name: 检查 Freqtrade 容器状态
      command: docker ps -f name=freqtrade
      register: container_status
      changed_when: false

    - name: 显示容器状态
      debug:
        var: container_status.stdout_lines

    - name: 显示配置信息
      debug:
        msg:
          - "使用的基础配置文件: base_config.json"
          - "使用的策略: {{ strategy_name | default('SampleStrategy') }}"
          - "Dry run 模式: {{ dry_run | default(true) }}"
          - "交易所: {{ exchange_name | default('binance') }}"
