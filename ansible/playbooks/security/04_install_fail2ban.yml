---
# fail2ban 部署 Playbook
# 安装和配置 fail2ban 入侵防护系统

- name: Install and Configure fail2ban
  hosts: all
  become: yes
  gather_facts: yes
  
  vars:
    # 默认值，可由 extra_vars 覆盖
    ssh_port: 6677
    fail2ban_bantime: 3600        # 封禁时间：1小时
    fail2ban_findtime: 600        # 查找时间窗口：10分钟
    fail2ban_maxretry: 3          # 最大重试次数：3次
    fail2ban_destemail: "admin@example.com"  # 告警邮箱
    fail2ban_sendername: "Fail2Ban"
  
  tasks:
    - name: Install fail2ban
      apt:
        name: fail2ban
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"
    
    - name: Create fail2ban configuration directory
      file:
        path: /etc/fail2ban
        state: directory
        mode: '0755'
    
    - name: Backup default fail2ban configuration
      copy:
        src: /etc/fail2ban/jail.conf
        dest: /etc/fail2ban/jail.conf.backup
        remote_src: yes
        mode: '0644'
      ignore_errors: yes
    
    - name: Create custom fail2ban local configuration
      copy:
        dest: /etc/fail2ban/jail.local
        content: |
          # Fail2Ban Local Configuration
          # Generated by Quants Infrastructure Security Manager
          
          [DEFAULT]
          # Ban settings
          bantime  = {{ fail2ban_bantime }}
          findtime = {{ fail2ban_findtime }}
          maxretry = {{ fail2ban_maxretry }}
          
          # Backend
          backend = systemd
          
          # Email settings (configure if email alerts needed)
          destemail = {{ fail2ban_destemail }}
          sendername = {{ fail2ban_sendername }}
          mta = sendmail
          
          # Action
          action = %(action_mwl)s
          
          # ================================
          # SSH Protection (CRITICAL)
          # ================================
          
          [sshd]
          enabled = true
          port = {{ ssh_port }}
          filter = sshd
          logpath = /var/log/auth.log
          maxretry = {{ fail2ban_maxretry }}
          bantime = {{ fail2ban_bantime }}
          findtime = {{ fail2ban_findtime }}
          
          # ================================
          # SSH DDOS Protection
          # ================================
          
          [sshd-ddos]
          enabled = true
          port = {{ ssh_port }}
          filter = sshd-ddos
          logpath = /var/log/auth.log
          maxretry = 6
          findtime = 60
          bantime = 600
          
          # ================================
          # Additional Services (if applicable)
          # ================================
          
          # Protect Nginx (if running web services)
          [nginx-http-auth]
          enabled = false
          port = http,https
          filter = nginx-http-auth
          logpath = /var/log/nginx/error.log
          
          [nginx-limit-req]
          enabled = false
          port = http,https
          filter = nginx-limit-req
          logpath = /var/log/nginx/error.log
          
          [nginx-botsearch]
          enabled = false
          port = http,https
          filter = nginx-botsearch
          logpath = /var/log/nginx/access.log
          
          # Protect Apache (if running)
          [apache-auth]
          enabled = false
          port = http,https
          filter = apache-auth
          logpath = /var/log/apache*/*error.log
          
          [apache-badbots]
          enabled = false
          port = http,https
          filter = apache-badbots
          logpath = /var/log/apache*/*access.log
          
          # Protect against port scanning
          [port-scan]
          enabled = true
          filter = port-scan
          logpath = /var/log/syslog
          maxretry = 5
          bantime = 86400  # 24 hours
          
          # Recidive jail - ban repeat offenders for longer
          [recidive]
          enabled = true
          filter = recidive
          logpath = /var/log/fail2ban.log
          bantime = 604800   # 1 week
          findtime = 86400   # 1 day
          maxretry = 3
        mode: '0644'
    
    - name: Create custom port-scan filter
      copy:
        dest: /etc/fail2ban/filter.d/port-scan.conf
        content: |
          # Fail2Ban filter for port scan detection
          [Definition]
          failregex = ^%(__prefix_line)sRefused connect from \S+ \(.*\)\s*$
                      ^%(__prefix_line)sDid not receive identification string from <HOST>\s*$
                      ^%(__prefix_line)sConnection closed by <HOST> port \d+ \[preauth\]\s*$
                      ^%(__prefix_line)sConnection reset by <HOST> port \d+ \[preauth\]\s*$
          ignoreregex =
        mode: '0644'
    
    - name: Create custom sshd-ddos filter (if not exists)
      copy:
        dest: /etc/fail2ban/filter.d/sshd-ddos.conf
        content: |
          # Fail2Ban filter for SSH DDOS
          [Definition]
          failregex = ^%(__prefix_line)sDid not receive identification string from <HOST>\s*$
          ignoreregex =
        mode: '0644'
        force: no
    
    - name: Create fail2ban systemd override directory
      file:
        path: /etc/systemd/system/fail2ban.service.d
        state: directory
        mode: '0755'
    
    - name: Configure fail2ban service override
      copy:
        dest: /etc/systemd/system/fail2ban.service.d/override.conf
        content: |
          [Unit]
          After=network.target iptables.service firewalld.service ip6tables.service ipset.service nftables.service
          
          [Service]
          # Restart fail2ban if it crashes
          Restart=on-failure
          RestartSec=5s
        mode: '0644'
      notify: reload systemd
    
    - name: Enable and start fail2ban service
      systemd:
        name: fail2ban
        enabled: yes
        state: started
        daemon_reload: yes
    
    - name: Wait for fail2ban to start
      wait_for:
        timeout: 10
    
    - name: Check fail2ban status
      command: fail2ban-client status
      register: fail2ban_status
      changed_when: false
    
    - name: Display fail2ban status
      debug:
        var: fail2ban_status.stdout_lines
    
    - name: Check SSH jail status
      command: fail2ban-client status sshd
      register: sshd_jail_status
      changed_when: false
    
    - name: Display SSH jail status
      debug:
        var: sshd_jail_status.stdout_lines
    
    - name: Create fail2ban management scripts
      copy:
        dest: "/opt/scripts/{{ item.name }}"
        content: "{{ item.content }}"
        mode: '0755'
      loop:
        - name: fail2ban-status.sh
          content: |
            #!/bin/bash
            # Fail2ban Status Script
            
            echo "=================================="
            echo "  Fail2ban Status"
            echo "=================================="
            echo ""
            
            # Overall status
            fail2ban-client status
            echo ""
            
            # SSH jail details
            echo "=== SSH Jail Details ==="
            fail2ban-client status sshd
            echo ""
            
            # SSH DDOS jail details
            echo "=== SSH DDOS Jail Details ==="
            fail2ban-client status sshd-ddos
            echo ""
            
            # Banned IPs
            echo "=== Currently Banned IPs ==="
            fail2ban-client status sshd | grep "Banned IP list:" | sed 's/.*://;s/\s/\n/g' | grep -v "^$"
            echo ""
        
        - name: fail2ban-unban.sh
          content: |
            #!/bin/bash
            # Unban an IP address from fail2ban
            
            if [ -z "$1" ]; then
              echo "Usage: $0 <IP_ADDRESS>"
              echo "Example: $0 192.168.1.100"
              exit 1
            fi
            
            IP="$1"
            
            echo "Unbanning IP: $IP"
            fail2ban-client set sshd unbanip "$IP"
            fail2ban-client set sshd-ddos unbanip "$IP"
            
            echo "IP $IP has been unbanned from all jails"
        
        - name: fail2ban-ban.sh
          content: |
            #!/bin/bash
            # Manually ban an IP address
            
            if [ -z "$1" ]; then
              echo "Usage: $0 <IP_ADDRESS>"
              echo "Example: $0 192.168.1.100"
              exit 1
            fi
            
            IP="$1"
            
            echo "Banning IP: $IP"
            fail2ban-client set sshd banip "$IP"
            
            echo "IP $IP has been banned"
    
    - name: Create fail2ban log rotation
      copy:
        dest: /etc/logrotate.d/fail2ban
        content: |
          /var/log/fail2ban.log {
              weekly
              rotate 4
              compress
              delaycompress
              missingok
              postrotate
                  fail2ban-client flushlogs >/dev/null || true
              endscript
          }
        mode: '0644'
    
    - name: Create fail2ban monitoring cron job
      cron:
        name: "Fail2ban status check"
        minute: "0"
        hour: "*/6"
        job: "/opt/scripts/fail2ban-status.sh > /var/log/fail2ban-status.log 2>&1"
        user: root
    
    - name: Test fail2ban regex patterns
      command: fail2ban-regex /var/log/auth.log /etc/fail2ban/filter.d/sshd.conf
      register: regex_test
      changed_when: false
      failed_when: false
    
    - name: Display regex test result summary
      debug:
        msg:
          - "Fail2ban regex test completed"
          - "Check /var/log/fail2ban.log for detailed match information"
    
    - name: Create fail2ban completion marker
      copy:
        dest: /etc/quants-security/fail2ban_installed
        content: |
          Fail2ban Installation Completed
          Timestamp: {{ ansible_date_time.iso8601 }}
          SSH Port: {{ ssh_port }}
          Ban Time: {{ fail2ban_bantime }}s
          Find Time: {{ fail2ban_findtime }}s
          Max Retry: {{ fail2ban_maxretry }}
          
          Management Scripts:
          - /opt/scripts/fail2ban-status.sh
          - /opt/scripts/fail2ban-unban.sh <IP>
          - /opt/scripts/fail2ban-ban.sh <IP>
        mode: '0644'
    
    - name: Display completion message
      debug:
        msg:
          - "============================================"
          - "Fail2ban Installation Completed"
          - "============================================"
          - "Configuration:"
          - "  - SSH Port Protected: {{ ssh_port }}"
          - "  - Ban Time: {{ fail2ban_bantime }}s ({{ fail2ban_bantime // 60 }} minutes)"
          - "  - Find Time: {{ fail2ban_findtime }}s ({{ fail2ban_findtime // 60 }} minutes)"
          - "  - Max Retry: {{ fail2ban_maxretry }} attempts"
          - ""
          - "Active Jails:"
          - "  - sshd: SSH brute-force protection"
          - "  - sshd-ddos: SSH DDOS protection"
          - "  - port-scan: Port scan detection"
          - "  - recidive: Repeat offender ban"
          - ""
          - "Management Commands:"
          - "  - Status: /opt/scripts/fail2ban-status.sh"
          - "  - Unban IP: /opt/scripts/fail2ban-unban.sh <IP>"
          - "  - Ban IP: /opt/scripts/fail2ban-ban.sh <IP>"
          - "  - Manual: fail2ban-client status"
          - ""
          - "Logs:"
          - "  - /var/log/fail2ban.log"
          - "  - /var/log/auth.log (SSH attempts)"
          - "============================================"
  
  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: yes

