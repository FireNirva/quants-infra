---
# 动态添加 Prometheus 抓取目标（修复版）
# 修复：正确的 job 更新逻辑，使用与 Prometheus 版本一致的 promtool

- name: 添加 Prometheus 抓取目标
  hosts: all
  become: yes
  vars:
    prometheus_dir: /opt/prometheus
    job_name: "{{ job_name }}"
    targets: "{{ targets }}"  # 格式: ["host1:port1", "host2:port2"]
    labels: "{{ labels | default({}) }}"  # 额外的标签
    
  tasks:
    - name: 检查 Prometheus 配置文件是否存在
      stat:
        path: "{{ prometheus_dir }}/prometheus.yml"
      register: config_file
    
    - name: 确认配置文件存在
      fail:
        msg: "Prometheus 配置文件不存在: {{ prometheus_dir }}/prometheus.yml"
      when: not config_file.stat.exists
    
    - name: 读取当前 Prometheus 配置
      slurp:
        src: "{{ prometheus_dir }}/prometheus.yml"
      register: current_config
    
    - name: 解析当前配置
      set_fact:
        prometheus_config: "{{ current_config.content | b64decode | from_yaml }}"
    
    - name: 检测 Prometheus 版本
      command: "docker inspect prometheus --format '{% raw %}{{.Config.Image}}{% endraw %}'"
      register: prom_image
      changed_when: false
    
    - name: 提取版本号
      set_fact:
        detected_version: "{{ prom_image.stdout | regex_search(':(v?[0-9.]+)', '\\1') | first | default('v2.48.0') }}"
    
    - name: 构建新的 scrape_config
      set_fact:
        new_scrape_config:
          job_name: "{{ job_name }}"
          static_configs:
            - targets: "{{ targets }}"
              labels: "{{ labels }}"
    
    - name: 查找 job 是否已存在
      set_fact:
        job_found: false
        job_index: -1
    
    - name: 遍历查找匹配的 job
      set_fact:
        job_found: true
        job_index: "{{ idx }}"
      loop: "{{ prometheus_config.scrape_configs }}"
      loop_control:
        index_var: idx
      when: item.job_name == job_name
    
    - name: 构建更新后的 scrape_configs（更新现有 job）
      set_fact:
        updated_scrape_configs: []
    
    - name: 构建新的配置列表（保留其他 job，替换匹配的 job）
      set_fact:
        updated_scrape_configs: "{{ updated_scrape_configs + [new_scrape_config if idx == (job_index | int) else item] }}"
      loop: "{{ prometheus_config.scrape_configs }}"
      loop_control:
        index_var: idx
      when: job_found
    
    - name: 添加新 job（如果不存在）
      set_fact:
        updated_scrape_configs: "{{ prometheus_config.scrape_configs + [new_scrape_config] }}"
      when: not job_found
    
    - name: 更新配置
      set_fact:
        updated_config: "{{ prometheus_config | combine({'scrape_configs': updated_scrape_configs}) }}"
    
    - name: 备份当前配置
      copy:
        src: "{{ prometheus_dir }}/prometheus.yml"
        dest: "{{ prometheus_dir }}/prometheus.yml.backup.{{ ansible_date_time.epoch }}"
        remote_src: yes
    
    - name: 写入新配置
      copy:
        content: "{{ updated_config | to_nice_yaml(indent=2) }}"
        dest: "{{ prometheus_dir }}/prometheus.yml"
        mode: '0644'
    
    - name: 验证新配置（使用检测到的版本）
      command: >
        docker run --rm
        --entrypoint promtool
        -v {{ prometheus_dir }}:/etc/prometheus
        prom/prometheus:{{ detected_version }}
        check config /etc/prometheus/prometheus.yml
      register: promtool_result
      failed_when: promtool_result.rc != 0
    
    - name: 配置验证失败时恢复备份
      copy:
        src: "{{ prometheus_dir }}/prometheus.yml.backup.{{ ansible_date_time.epoch }}"
        dest: "{{ prometheus_dir }}/prometheus.yml"
        remote_src: yes
      when: promtool_result.rc != 0
    
    - name: 重载 Prometheus 配置
      uri:
        url: "http://localhost:9090/-/reload"
        method: POST
        status_code: 200
      register: reload_result
      failed_when: false
    
    - name: 如果重载失败，重启 Prometheus 容器
      docker_container:
        name: prometheus
        state: started
        restart: yes
      when: reload_result.status != 200
    
    - name: 显示添加结果
      debug:
        msg:
          - "✅ Prometheus 目标添加成功"
          - "Job 名称: {{ job_name }}"
          - "目标: {{ targets }}"
          - "标签: {{ labels }}"
          - "{% if existing_job_index is defined %}已更新现有 job{% else %}已添加新 job{% endif %}"
          - "配置备份: prometheus.yml.backup.{{ ansible_date_time.epoch }}"
