---
# åŠ¨æ€æ·»åŠ  Prometheus æŠ“å–ç›®æ ‡ï¼ˆä¿®å¤ç‰ˆï¼‰
# ä¿®å¤ï¼šæ­£ç¡®çš„ job æ›´æ–°é€»è¾‘ï¼Œä½¿ç”¨ä¸ Prometheus ç‰ˆæœ¬ä¸€è‡´çš„ promtool

- name: æ·»åŠ  Prometheus æŠ“å–ç›®æ ‡
  hosts: all
  become: yes
  vars:
    prometheus_dir: /opt/prometheus
    job_name: "{{ job_name }}"
    targets: "{{ targets }}"  # æ ¼å¼: ["host1:port1", "host2:port2"]
    labels: "{{ labels | default({}) }}"  # é¢å¤–çš„æ ‡ç­¾
    
  tasks:
    - name: æ£€æŸ¥ Prometheus é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      stat:
        path: "{{ prometheus_dir }}/prometheus.yml"
      register: config_file
    
    - name: ç¡®è®¤é…ç½®æ–‡ä»¶å­˜åœ¨
      fail:
        msg: "Prometheus é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {{ prometheus_dir }}/prometheus.yml"
      when: not config_file.stat.exists
    
    - name: è¯»å–å½“å‰ Prometheus é…ç½®
      slurp:
        src: "{{ prometheus_dir }}/prometheus.yml"
      register: current_config
    
    - name: è§£æå½“å‰é…ç½®
      set_fact:
        prometheus_config: "{{ current_config.content | b64decode | from_yaml }}"
    
    - name: æ£€æµ‹ Prometheus ç‰ˆæœ¬
      command: "docker inspect prometheus --format '{% raw %}{{.Config.Image}}{% endraw %}'"
      register: prom_image
      changed_when: false
    
    - name: æå–ç‰ˆæœ¬å·
      set_fact:
        detected_version: "{{ prom_image.stdout | regex_search(':(v?[0-9.]+)', '\\1') | first | default('v2.48.0') }}"
    
    - name: æ„å»ºæ–°çš„ scrape_config
      set_fact:
        new_scrape_config:
          job_name: "{{ job_name }}"
          static_configs:
            - targets: "{{ targets }}"
              labels: "{{ labels }}"
    
    - name: æŸ¥æ‰¾ job æ˜¯å¦å·²å­˜åœ¨
      set_fact:
        job_found: false
        job_index: -1
    
    - name: éå†æŸ¥æ‰¾åŒ¹é…çš„ job
      set_fact:
        job_found: true
        job_index: "{{ idx }}"
      loop: "{{ prometheus_config.scrape_configs }}"
      loop_control:
        index_var: idx
      when: item.job_name == job_name
    
    - name: æ„å»ºæ›´æ–°åçš„ scrape_configsï¼ˆæ›´æ–°ç°æœ‰ jobï¼‰
      set_fact:
        updated_scrape_configs: []
    
    - name: æ„å»ºæ–°çš„é…ç½®åˆ—è¡¨ï¼ˆä¿ç•™å…¶ä»– jobï¼Œæ›¿æ¢åŒ¹é…çš„ jobï¼‰
      set_fact:
        updated_scrape_configs: "{{ updated_scrape_configs + [new_scrape_config if idx == (job_index | int) else item] }}"
      loop: "{{ prometheus_config.scrape_configs }}"
      loop_control:
        index_var: idx
      when: job_found
    
    - name: æ·»åŠ æ–° jobï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
      set_fact:
        updated_scrape_configs: "{{ prometheus_config.scrape_configs + [new_scrape_config] }}"
      when: not job_found
    
    - name: æ›´æ–°é…ç½®
      set_fact:
        updated_config: "{{ prometheus_config | combine({'scrape_configs': updated_scrape_configs}) }}"
    
    - name: å¤‡ä»½å½“å‰é…ç½®
      copy:
        src: "{{ prometheus_dir }}/prometheus.yml"
        dest: "{{ prometheus_dir }}/prometheus.yml.backup.{{ ansible_date_time.epoch }}"
        remote_src: yes
    
    - name: å†™å…¥æ–°é…ç½®
      copy:
        content: "{{ updated_config | to_nice_yaml(indent=2) }}"
        dest: "{{ prometheus_dir }}/prometheus.yml"
        mode: '0644'
    
    - name: éªŒè¯æ–°é…ç½®ï¼ˆä½¿ç”¨æ£€æµ‹åˆ°çš„ç‰ˆæœ¬ï¼‰
      command: >
        docker run --rm
        --entrypoint promtool
        -v {{ prometheus_dir }}:/etc/prometheus
        prom/prometheus:{{ detected_version }}
        check config /etc/prometheus/prometheus.yml
      register: promtool_result
      failed_when: promtool_result.rc != 0
    
    - name: é…ç½®éªŒè¯å¤±è´¥æ—¶æ¢å¤å¤‡ä»½
      copy:
        src: "{{ prometheus_dir }}/prometheus.yml.backup.{{ ansible_date_time.epoch }}"
        dest: "{{ prometheus_dir }}/prometheus.yml"
        remote_src: yes
      when: promtool_result.rc != 0
    
    - name: å°è¯•é‡è½½ Prometheus é…ç½®
      uri:
        url: "http://localhost:9090/-/reload"
        method: POST
        status_code: [200, 202]
        timeout: 10
      register: reload_result
      failed_when: false
      ignore_errors: yes
    
    - name: æ£€æŸ¥ reload æ˜¯å¦æˆåŠŸ
      set_fact:
        reload_success: "{{ reload_result.status is defined and reload_result.status in [200, 202] }}"
    
    - name: æ˜¾ç¤º reload ç»“æœ
      debug:
        msg:
          - "Reload çŠ¶æ€: {{ reload_result.status | default('æœªå®šä¹‰') }}"
          - "Reload æˆåŠŸ: {{ reload_success }}"
    
    - name: ç­‰å¾…é…ç½®ç”Ÿæ•ˆï¼ˆç»™ Prometheus æ—¶é—´é‡æ–°åŠ è½½ï¼‰
      pause:
        seconds: 3
      when: reload_success
    
    - name: éªŒè¯é…ç½®æ˜¯å¦çœŸçš„ç”Ÿæ•ˆï¼ˆæ£€æŸ¥ job æ˜¯å¦å‡ºç°ï¼‰
      uri:
        url: "http://localhost:9090/api/v1/targets"
        method: GET
        timeout: 5
      register: targets_check
      failed_when: false
      ignore_errors: yes
      when: reload_success
    
    - name: è§£æ targets å¹¶æ£€æŸ¥æ–° job æ˜¯å¦å­˜åœ¨
      set_fact:
        config_actually_applied: "{{ job_name in (targets_check.json.data.activeTargets | map(attribute='labels') | map(attribute='job') | list) }}"
      when: reload_success and targets_check.status is defined and targets_check.status == 200
    
    - name: æ˜¾ç¤ºé…ç½®éªŒè¯ç»“æœ
      debug:
        msg:
          - "é…ç½®æ˜¯å¦çœŸçš„ç”Ÿæ•ˆ: {{ config_actually_applied | default('æœªæ£€æŸ¥') }}"
          - "å¦‚æœé…ç½®æœªç”Ÿæ•ˆï¼Œå°†å¼ºåˆ¶é‡å¯ Prometheus å®¹å™¨"
      when: reload_success
    
    - name: å¦‚æœ reload å¤±è´¥æˆ–é…ç½®æœªç”Ÿæ•ˆï¼Œå¼ºåˆ¶é‡å¯ Prometheus å®¹å™¨
      command: docker restart prometheus
      when: not reload_success or (reload_success and not (config_actually_applied | default(false)))
      register: restart_result
    
    - name: æ˜¾ç¤ºé‡å¯åŸå› 
      debug:
        msg: "é‡å¯åŸå› : {% if not reload_success %}Reload å¤±è´¥{% else %}é…ç½®æœªç”Ÿæ•ˆï¼ˆåªè¯»æŒ‚è½½é—®é¢˜ï¼‰{% endif %}"
      when: not reload_success or (reload_success and not (config_actually_applied | default(false)))
    
    - name: ç­‰å¾… Prometheus é‡å¯å®Œæˆ
      wait_for:
        host: localhost
        port: 9090
        delay: 5
        timeout: 60
      when: not reload_success or (reload_success and not (config_actually_applied | default(false)))
    
    - name: éªŒè¯ Prometheus å·²å¯åŠ¨
      uri:
        url: "http://localhost:9090/-/healthy"
        method: GET
        status_code: 200
        timeout: 5
      retries: 12
      delay: 5
      when: not reload_success or (reload_success and not (config_actually_applied | default(false)))
    
    - name: ç¡®å®šæœ€ç»ˆä½¿ç”¨çš„æ›´æ–°æ–¹å¼
      set_fact:
        final_update_method: "{% if reload_success and (config_actually_applied | default(false)) %}é…ç½®çƒ­é‡è½½{% else %}å®¹å™¨é‡å¯{% endif %}"
    
    - name: æ˜¾ç¤ºæ·»åŠ ç»“æœ
      debug:
        msg:
          - "âœ… Prometheus ç›®æ ‡æ·»åŠ æˆåŠŸ"
          - "Job åç§°: {{ job_name }}"
          - "ç›®æ ‡: {{ targets }}"
          - "æ ‡ç­¾: {{ labels }}"
          - "{% if job_found %}å·²æ›´æ–°ç°æœ‰ job{% else %}å·²æ·»åŠ æ–° job{% endif %}"
          - "é…ç½®å¤‡ä»½: prometheus.yml.backup.{{ ansible_date_time.epoch }}"
          - "æ›´æ–°æ–¹å¼: {{ final_update_method }}"
          - ""
          - "ğŸ’¡ æç¤º: {% if final_update_method == 'é…ç½®çƒ­é‡è½½' %}æ–°ç›®æ ‡å°†åœ¨ 30 ç§’å†…å‡ºç°{% else %}æ–°ç›®æ ‡å°†åœ¨å®¹å™¨é‡å¯åç«‹å³å‡ºç°{% endif %}"
